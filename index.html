<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Simulation Platform</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        h2 { color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 25px; }
        .panel { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { border: 1px solid #eee; padding: 8px 12px; text-align: left; }
        th { background-color: #f8f8f8; font-weight: 600; }
        tr:nth-child(even) { background-color: #fafafa; }
        button, input[type="text"], input[type="number"] { padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        button { background-color: #3498db; color: white; cursor: pointer; border: none; transition: background-color 0.2s; margin-right: 10px; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #95a5a6; cursor: not-allowed; }
        input[type="number"] { width: 80px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .success { color: #27ae60; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        #trade-symbol { width: 120px; }
    </style>
</head>
<body>
    <h1>Market Simulation Platform</h1>

    <div class="container">
        <div class="panel">
            <h2>Market Prices</h2>
            <div id="market-prices">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Stock prices will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h2>Your Portfolio</h2>
            <p>Cash: <span id="portfolio-cash">$10,000.00</span></p>
            <div id="portfolio-holdings">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Avg. Price</th>
                            <th>Current Price</th>
                            <th>Total Value</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Portfolio holdings will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <h2>Trade Stocks</h2>
            <div class="form-group">
                <label for="trade-symbol">Symbol:</label>
                <input type="text" id="trade-symbol" placeholder="e.g., AAPL" list="stock-symbols">
                <datalist id="stock-symbols"></datalist>
            </div>
            <div class="form-group">
                <label for="trade-quantity">Quantity:</label>
                <input type="number" id="trade-quantity" value="1" min="1">
            </div>
            <button id="buy-button">Buy</button>
            <button id="sell-button">Sell</button>
            <p id="trade-message" style="margin-top: 15px;"></p>
        </div>

        <div class="panel">
            <h2>Transaction History</h2>
            <div id="transaction-history">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Transaction history will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'marketSimulatorData';
        let stocks = [];
        let portfolio = {
            cash: 10000,
            holdings: [] // { symbol, quantity, avgPrice }
        };
        let transactions = []; // { type: 'buy'/'sell', symbol, quantity, price, timestamp }

        // --- DOM Elements ---
        const marketPricesBody = document.querySelector('#market-prices tbody');
        const portfolioCashSpan = document.getElementById('portfolio-cash');
        const portfolioHoldingsBody = document.querySelector('#portfolio-holdings tbody');
        const transactionHistoryBody = document.querySelector('#transaction-history tbody');
        const tradeSymbolInput = document.getElementById('trade-symbol');
        const tradeQuantityInput = document.getElementById('trade-quantity');
        const buyButton = document.getElementById('buy-button');
        const sellButton = document.getElementById('sell-button');
        const tradeMessage = document.getElementById('trade-message');
        const stockSymbolsDatalist = document.getElementById('stock-symbols');

        // --- Core Functions ---

        function initData() {
            // Initialize some sample stocks
            stocks = [
                { symbol: 'AAPL', name: 'Apple Inc.', price: 150.00 },
                { symbol: 'GOOG', name: 'Alphabet Inc.', price: 2500.00 },
                { symbol: 'MSFT', name: 'Microsoft Corp.', price: 280.00 },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 3000.00 },
                { symbol: 'TSLA', name: 'Tesla Inc.', price: 800.00 },
            ];

            // Load data from localStorage if available
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                portfolio = data.portfolio || portfolio;
                transactions = data.transactions || transactions;
                if (data.stocks) {
                     // Merge saved prices with initial stock definitions
                     stocks = stocks.map(initialStock => {
                        const savedStock = data.stocks.find(s => s.symbol === initialStock.symbol);
                        return savedStock ? { ...initialStock, price: savedStock.price, lastRenderedPrice: savedStock.price } : initialStock;
                    });
                }
            }
            // Ensure all stocks have a lastRenderedPrice, even if not loaded from storage
            stocks.forEach(stock => {
                if (stock.lastRenderedPrice === undefined) {
                    stock.lastRenderedPrice = stock.price;
                }
            });
        }

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ portfolio, transactions, stocks: stocks.map(({lastRenderedPrice, ...rest}) => rest) }));
        }

        function updateStockPrices() {
            stocks.forEach(stock => {
                const changePercent = (Math.random() * 0.02 - 0.01); // -1% to +1% change
                stock.price *= (1 + changePercent);
                stock.price = parseFloat(stock.price.toFixed(2));
            });
            renderAll();
        }

        function renderStocks() {
            marketPricesBody.innerHTML = '';
            stockSymbolsDatalist.innerHTML = '';
            stocks.forEach(stock => {
                const change = stock.price - stock.lastRenderedPrice;
                const changeClass = change > 0 ? 'success' : (change < 0 ? 'error' : '');

                const row = marketPricesBody.insertRow();
                row.insertCell().textContent = stock.symbol;
                row.insertCell().textContent = stock.name;
                row.insertCell().textContent = `$${stock.price.toFixed(2)}`;
                const changeCell = row.insertCell();
                changeCell.textContent = `${change > 0 ? '+' : ''}${change.toFixed(2)}`;
                changeCell.classList.add(changeClass);

                // Add to datalist for trade input
                const option = document.createElement('option');
                option.value = stock.symbol;
                stockSymbolsDatalist.appendChild(option);
            });
            // After rendering, update lastRenderedPrice for the next cycle's calculation
            stocks.forEach(stock => stock.lastRenderedPrice = stock.price);
        }

        function renderPortfolio() {
            portfolioCashSpan.textContent = `$${portfolio.cash.toFixed(2)}`;
            portfolioHoldingsBody.innerHTML = '';

            if (portfolio.holdings.length === 0) {
                const row = portfolioHoldingsBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = 'No holdings yet.';
                cell.style.textAlign = 'center';
                return;
            }

            portfolio.holdings.forEach(holding => {
                const currentStock = stocks.find(s => s.symbol === holding.symbol);
                if (!currentStock) return; // Stock might have been removed

                const currentValue = holding.quantity * currentStock.price;
                const totalInvested = holding.quantity * holding.avgPrice;
                const profitLoss = currentValue - totalInvested;
                const profitLossClass = profitLoss > 0 ? 'success' : (profitLoss < 0 ? 'error' : '');

                const row = portfolioHoldingsBody.insertRow();
                row.insertCell().textContent = holding.symbol;
                row.insertCell().textContent = holding.quantity;
                row.insertCell().textContent = `$${holding.avgPrice.toFixed(2)}`;
                row.insertCell().textContent = `$${currentStock.price.toFixed(2)}`;
                row.insertCell().textContent = `$${currentValue.toFixed(2)}`;
                const plCell = row.insertCell();
                plCell.textContent = `$${profitLoss.toFixed(2)}`;
                plCell.classList.add(profitLossClass);
            });
        }

        function renderTransactions() {
            transactionHistoryBody.innerHTML = '';
            if (transactions.length === 0) {
                const row = transactionHistoryBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 5;
                cell.textContent = 'No transactions yet.';
                cell.style.textAlign = 'center';
                return;
            }

            transactions.slice().reverse().forEach(tx => { // Show most recent first
                const row = transactionHistoryBody.insertRow();
                row.insertCell().textContent = tx.type.toUpperCase();
                row.insertCell().textContent = tx.symbol;
                row.insertCell().textContent = tx.quantity;
                row.insertCell().textContent = `$${tx.price.toFixed(2)}`;
                row.insertCell().textContent = new Date(tx.timestamp).toLocaleString();
            });
        }

        function showTradeMessage(message, type = '') {
            tradeMessage.textContent = message;
            tradeMessage.className = type; // 'success' or 'error'
            setTimeout(() => { tradeMessage.textContent = ''; tradeMessage.className = ''; }, 3000);
        }

        function executeTrade(type) {
            const symbol = tradeSymbolInput.value.toUpperCase().trim();
            const quantity = parseInt(tradeQuantityInput.value);

            if (!symbol || isNaN(quantity) || quantity <= 0) {
                showTradeMessage('Please enter a valid symbol and quantity.', 'error');
                return;
            }

            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) {
                showTradeMessage(`Stock ${symbol} not found.`, 'error');
                return;
            }

            const cost = stock.price * quantity;

            if (type === 'buy') {
                if (portfolio.cash < cost) {
                    showTradeMessage('Not enough cash to complete the purchase.', 'error');
                    return;
                }

                portfolio.cash -= cost;
                let holding = portfolio.holdings.find(h => h.symbol === symbol);

                if (holding) {
                    const totalCost = (holding.avgPrice * holding.quantity) + cost;
                    holding.quantity += quantity;
                    holding.avgPrice = totalCost / holding.quantity;
                } else {
                    portfolio.holdings.push({ symbol, quantity, avgPrice: stock.price });
                }

                transactions.push({
                    type: 'buy',
                    symbol,
                    quantity,
                    price: stock.price,
                    timestamp: new Date().toISOString()
                });
                showTradeMessage(`Bought ${quantity} shares of ${symbol} for $${cost.toFixed(2)}.`, 'success');

            } else if (type === 'sell') {
                const holding = portfolio.holdings.find(h => h.symbol === symbol);

                if (!holding || holding.quantity < quantity) {
                    showTradeMessage(`You do not own ${quantity} shares of ${symbol}.`, 'error');
                    return;
                }

                portfolio.cash += cost; // Selling increases cash
                holding.quantity -= quantity;

                if (holding.quantity === 0) {
                    portfolio.holdings = portfolio.holdings.filter(h => h.symbol !== symbol);
                }

                transactions.push({
                    type: 'sell',
                    symbol,
                    quantity,
                    price: stock.price,
                    timestamp: new Date().toISOString()
                });
                showTradeMessage(`Sold ${quantity} shares of ${symbol} for $${cost.toFixed(2)}.`, 'success');
            }
            tradeSymbolInput.value = '';
            tradeQuantityInput.value = '1';
            renderAll();
            saveState();
        }

        function renderAll() {
            renderStocks();
            renderPortfolio();
            renderTransactions();
        }

        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            renderAll();
            setInterval(updateStockPrices, 5000); // Update prices every 5 seconds
        });

        buyButton.addEventListener('click', () => executeTrade('buy'));
        sellButton.addEventListener('click', () => executeTrade('sell'));
    </script>
</body>
</html>